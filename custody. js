import { db, ref, push, onValue, update, remove } from "./firebase.js";

let currentUserRole = '';
let currentUserUid = '';

export function loadCustody(role, uid) {
  currentUserRole = role;
  currentUserUid = uid;

  const content = document.getElementById('content');
  content.innerHTML = `
    <h2>Ø§Ù„Ø¹Ù‡Ø¯Ø©</h2>
    ${['Ù…Ø·ÙˆØ±','Ù…Ø¯ÙŠØ±','Ù…Ø´Ø±Ù'].includes(role) ? `<button class="action-btn" id="add-custody">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>` : ''}
    <div id="custody-list"></div>
  `;

  const custodyRef = ref(db, 'custody');
  onValue(custodyRef, (snapshot) => {
    const list = document.getElementById('custody-list');
    list.innerHTML = '';
    const data = snapshot.val() || {};

    // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¶Ùˆ
    const byMember = {};
    Object.keys(data).forEach(key => {
      const c = data[key];
      if (role === 'Ø¹Ø¶Ùˆ' && c.memberUid !== uid) return;
      if (!byMember[c.memberUid]) byMember[c.memberUid] = { name: c.memberName, cars: [] };
      byMember[c.memberUid].cars.push({ ...c, key });
    });

    Object.keys(byMember).forEach(memberUid => {
      const member = byMember[memberUid];
      const accordion = document.createElement('div');
      accordion.className = 'accordion';
      accordion.innerHTML = `<strong>${member.name} (${member.cars.length} Ø³ÙŠØ§Ø±Ø©)</strong>`;

      const panel = document.createElement('div');
      panel.className = 'panel';
      member.cars.forEach(car => {
        panel.innerHTML += `
          <div style="border:1px solid #ccc; padding:10px; margin:10px 0;">
            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${car.carNumber}</p>
            <p><strong>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©:</strong> ${car.plateCode}</p>
            <p><strong>Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> ${car.owner}</p>
            <p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${car.carType}</p>
            <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${car.notes || '-'}</p>
            ${['Ù…Ø·ÙˆØ±','Ù…Ø¯ÙŠØ±','Ù…Ø´Ø±Ù'].includes(role) ? `
              <button class="action-btn" onclick="editCustody('${car.key}')">âœ ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="action-btn" style="background:red;" onclick="deleteCustody('${car.key}')">ğŸ—‘ Ø­Ø°Ù</button>
            ` : ''}
          </div>
        `;
      });

      accordion.onclick = () => panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
      list.appendChild(accordion);
      list.appendChild(panel);
    });
  });

  if (document.getElementById('add-custody')) {
    document.getElementById('add-custody').onclick = () => openCustodyForm();
  }
}

function openCustodyForm(editKey = null) {
  const membersRef = ref(db, 'members');
  onValue(membersRef, (snap) => {
    let options = '';
    snap.forEach(child => {
      options += `<option value="${child.key}">${child.val().username}</option>`;
    });

    const content = document.getElementById('content');
    content.innerHTML = `
      <h2>${editKey ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©'} Ø¹Ù‡Ø¯Ø©</h2>
      <label>Ø§Ù„Ù…ØªØ¹Ù‡Ø¯:</label>
      <select id="memberUid">${options}</select>
      <label>Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</label>
      <input type="text" id="carNumber">
      <label>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©:</label>
      <input type="text" id="plateCode">
      <label>Ø§Ù„Ù…Ø§Ù„Ùƒ:</label>
      <input type="text" id="owner">
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</label>
      <input type="text" id="carType">
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
      <textarea id="notes"></textarea>
      <button class="action-btn" id="save-custody">Ø­ÙØ¸</button>
      <button class="action-btn" onclick="loadCustody('${currentUserRole}', '${currentUserUid}')">Ø¥Ù„ØºØ§Ø¡</button>
    `;

    if (editKey) {
      onValue(ref(db, 'custody/' + editKey), (snap) => {
        const c = snap.val();
        document.getElementById('memberUid').value = c.memberUid;
        document.getElementById('carNumber').value = c.carNumber;
        document.getElementById('plateCode').value = c.plateCode;
        document.getElementById('owner').value = c.owner;
        document.getElementById('carType').value = c.carType;
        document.getElementById('notes').value = c.notes;
      }, { onlyOnce: true });
    }

    document.getElementById('save-custody').onclick = () => {
      const memberUid = document.getElementById('memberUid').value;
      const memberName = document.querySelector(`#memberUid option[value="${memberUid}"]`).textContent;

      const custody = {
        memberUid,
        memberName,
        carNumber: document.getElementById('carNumber').value,
        plateCode: document.getElementById('plateCode').value,
        owner: document.getElementById('owner').value,
        carType: document.getElementById('carType').value,
        notes: document.getElementById('notes').value
      };

      if (editKey) {
        update(ref(db, 'custody/' + editKey), custody);
      } else {
        push(ref(db, 'custody'), custody);
      }
      loadCustody(currentUserRole, currentUserUid);
    };
  }, { onlyOnce: true });
}

window.editCustody = (key) => openCustodyForm(key);
window.deleteCustody = (key) => { if (confirm('Ø­Ø°ÙØŸ')) remove(ref(db, 'custody/' + key)); };