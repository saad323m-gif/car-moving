// custody.js
import {
  db,
  collection,
  doc,
  addDoc,
  getDocs,
  updateDoc,
  deleteDoc,
  query,
  where,
  orderBy,
  serverTimestamp
} from "./firebase.js";

import { currentUserProfile } from "./auth.js";
import {
  canSeeAllCustody
} from "./roles.js";

const custodyList = document.getElementById("custodyList");
const custodyFormContainer = document.getElementById("custodyFormContainer");
const addCustodyBtn = document.getElementById("addCustodyBtn");

function getNowGmt4Iso() {
  const nowUtc = new Date();
  const utcMs = nowUtc.getTime() + nowUtc.getTimezoneOffset() * 60000;
  const gmt4Ms = utcMs + 4 * 60 * 60 * 1000;
  return new Date(gmt4Ms).toISOString();
}

// ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù‡Ø¯Ø©
function canEditCustody(user) {
  if (!user) return false;
  return canSeeAllCustody(user.role); // Ù…Ø·ÙˆØ± + Ù…Ø¯ÙŠØ± + Ù…Ø´Ø±Ù
}

function canDeleteCustody(user) {
  if (!user) return false;
  return canSeeAllCustody(user.role);
}

// Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‡Ø¯Ø©
function renderCustodyForm(existing) {
  custodyFormContainer.innerHTML = "";
  const isEdit = !!existing;
  const card = document.createElement("div");
  card.className = "card";

  const title = document.createElement("h3");
  title.textContent = isEdit ? "ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‡Ø¯Ø©" : "Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©";
  card.appendChild(title);

  const form = document.createElement("form");
  form.className = "form";

  form.innerHTML = `
    <div class="form-group">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¹Ù‡Ø¯ (Ø¹Ø¶Ùˆ)</label>
      <input type="text" name="custodianName" required value="${existing?.custodianName || ""}" />
    </div>
    <div class="form-group">
      <label>Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
      <input type="text" name="carNumber" required value="${existing?.carNumber || ""}" />
    </div>
    <div class="form-group">
      <label>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©</label>
      <input type="text" name="plateCode" required value="${existing?.plateCode || ""}" />
    </div>
    <div class="form-group">
      <label>Ø§Ù„Ù…Ø§Ù„Ùƒ</label>
      <input type="text" name="owner" required value="${existing?.owner || ""}" />
    </div>
    <div class="form-group">
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
      <input type="text" name="carType" required value="${existing?.carType || ""}" />
    </div>
    <div class="form-group">
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea name="notes">${existing?.notes || ""}</textarea>
    </div>
    <p class="hint-text">
      Ø§Ù„Ø¹Ø¶Ùˆ (Ø§Ù„Ù…ØªØ¹Ù‡Ø¯) ÙŠØ±Ù‰ Ø¹Ù‡Ø¯ØªÙ‡ ÙÙ‚Ø·ØŒ ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† ÙŠØ±ÙˆÙ† ÙƒÙ„ Ø§Ù„Ø¹Ù‡Ø¯.
    </p>
    <div class="form-inline" style="margin-top:0.5rem;">
      <button type="submit" class="btn btn-primary">${isEdit ? "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" : "Ø­ÙØ¸"}</button>
      <button type="button" class="btn btn-secondary" id="cancelCustodyForm">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    const user = currentUserProfile;

    const payload = {
      custodianName: data.custodianName.trim(),
      custodianUid: existing?.custodianUid || user.uid, // ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
      carNumber: data.carNumber.trim(),
      plateCode: data.plateCode.trim(),
      owner: data.owner.trim(),
      carType: data.carType.trim(),
      notes: data.notes.trim(),
    };

    try {
      if (isEdit) {
        await updateDoc(doc(db, "custody", existing.id), {
          ...payload,
          lastEditedByUid: user.uid,
          lastEditedByName: user.fullName,
          lastEditedAt: getNowGmt4Iso()
        });
      } else {
        await addDoc(collection(db, "custody"), {
          ...payload,
          createdAt: serverTimestamp(),
          createdAtGmt4Iso: getNowGmt4Iso()
        });
      }
      custodyFormContainer.classList.add("hidden");
      await loadCustody();
    } catch (err) {
      console.error(err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‡Ø¯Ø©.");
    }
  });

  card.appendChild(form);
  custodyFormContainer.appendChild(card);
  custodyFormContainer.classList.remove("hidden");

  document
    .getElementById("cancelCustodyForm")
    .addEventListener("click", () => {
      custodyFormContainer.classList.add("hidden");
    });
}

if (addCustodyBtn) {
  addCustodyBtn.addEventListener("click", () => {
    const user = currentUserProfile;
    if (!canEditCustody(user)) {
      alert("Ù„ÙŠØ³Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©.");
      return;
    }
    renderCustodyForm(null);
  });
}

// Ø§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ†: ØªØ¬Ù…ÙŠØ¹ Ø¨Ø§Ù„Ø¹ÙÙ‡Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ¹Ù‡Ø¯
function renderCustodyGrouped(records) {
  custodyList.innerHTML = "";

  const user = currentUserProfile;
  const canSeeAll = canSeeAllCustody(user.role);

  // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  const filtered = records.filter((r) =>
    canSeeAll ? true : r.custodianUid === user.uid
  );

  // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ¹Ù‡Ø¯
  const groups = {};
  filtered.forEach((r) => {
    const key = `${r.custodianUid}::${r.custodianName}`;
    if (!groups[key]) groups[key] = [];
    groups[key].push(r);
  });

  Object.keys(groups).forEach((key) => {
    const [uid, name] = key.split("::");
    const cars = groups[key];

    const item = document.createElement("div");
    item.className = "accordion-item";

    const header = document.createElement("div");
    header.className = "accordion-header";

    const headerMain = document.createElement("div");
    headerMain.className = "accordion-header-main";

    const title = document.createElement("div");
    title.className = "accordion-title";
    title.textContent = name || "Ù…Ø¬Ù‡ÙˆÙ„";

    const subtitle = document.createElement("div");
    subtitle.className = "accordion-subtitle";
    subtitle.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù‡Ø¯Ø©: ${cars.length}`;

    headerMain.appendChild(title);
    headerMain.appendChild(subtitle);

    const toggle = document.createElement("div");
    toggle.className = "accordion-toggle";
    toggle.textContent = "â–¼";

    header.appendChild(headerMain);
    header.appendChild(toggle);

    const body = document.createElement("div");
    body.className = "accordion-body hidden";

    cars.forEach((c) => {
      const block = document.createElement("div");
      block.style.borderBottom = "1px solid #e2e8f0";
      block.style.paddingBottom = "0.4rem";
      block.style.marginBottom = "0.4rem";

      block.innerHTML = `
        <div class="accordion-body-row">
          <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
          <span class="value">${c.carNumber}</span>
        </div>
        <div class="accordion-body-row">
          <span class="label">ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©:</span>
          <span class="value">${c.plateCode}</span>
        </div>
        <div class="accordion-body-row">
          <span class="label">Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
          <span class="value">${c.owner}</span>
        </div>
        <div class="accordion-body-row">
          <span class="label">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
          <span class="value">${c.carType}</span>
        </div>
        <div class="accordion-body-row">
          <span class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
          <span class="value">${c.notes || "-"}</span>
        </div>
      `;

      const actions = document.createElement("div");
      actions.className = "accordion-actions";

      const shareBtn = document.createElement("button");
      shareBtn.className = "btn btn-secondary";
      shareBtn.textContent = "ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©";
      shareBtn.addEventListener("click", () => {
        const text = `
Ø¹Ù‡Ø¯Ø© Ø³ÙŠØ§Ø±Ø©
Ø§Ù„Ù…ØªØ¹Ù‡Ø¯: ${c.custodianName}
Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${c.carNumber}
ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©: ${c.plateCode}
Ø§Ù„Ù…Ø§Ù„Ùƒ: ${c.owner}
Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${c.carType}
Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${c.notes || "-"}
        `.trim();
        if (navigator.share) {
          navigator.share({ text }).catch(() => {});
        } else {
          navigator.clipboard?.writeText(text);
          alert("ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‡Ø¯Ø©.");
        }
      });

      const printBtn = document.createElement("button");
      printBtn.className = "btn btn-secondary";
      printBtn.textContent = "ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©";
      printBtn.addEventListener("click", () => {
        const w = window.open("", "_blank");
        w.document.write(`
          <html dir="rtl" lang="ar"><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù‡Ø¯Ø©</title></head><body>
          <h2>Ø¨ÙŠØ§Ù† Ø¹Ù‡Ø¯Ø©</h2>
          <p>Ø§Ù„Ù…ØªØ¹Ù‡Ø¯: ${c.custodianName}</p>
          <p>Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${c.carNumber}</p>
          <p>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©: ${c.plateCode}</p>
          <p>Ø§Ù„Ù…Ø§Ù„Ùƒ: ${c.owner}</p>
          <p>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${c.carType}</p>
          <p>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${c.notes || "-"}</p>
          </body></html>
        `);
        w.document.close();
        w.print();
      });

      actions.appendChild(shareBtn);
      actions.appendChild(printBtn);

      if (canEditCustody(currentUserProfile)) {
        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-primary";
        editBtn.textContent = "âœ ØªØ¹Ø¯ÙŠÙ„";
        editBtn.addEventListener("click", () => {
          renderCustodyForm({ id: c.id, ...c });
        });
        actions.appendChild(editBtn);
      }

      if (canDeleteCustody(currentUserProfile)) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-danger";
        deleteBtn.textContent = "ğŸ—‘ Ø­Ø°Ù";
        deleteBtn.addEventListener("click", async () => {
          if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ")) return;
          try {
            await deleteDoc(doc(db, "custody", c.id));
            await loadCustody();
          } catch (err) {
            console.error(err);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù.");
          }
        });
        actions.appendChild(deleteBtn);
      }

      block.appendChild(actions);
      body.appendChild(block);
    });

    header.addEventListener("click", () => {
      const isHidden = body.classList.contains("hidden");
      body.classList.toggle("hidden", !isHidden);
      toggle.textContent = isHidden ? "â–²" : "â–¼";
    });

    item.appendChild(header);
    item.appendChild(body);

    custodyList.appendChild(item);
  });

  if (!filtered.length) {
    custodyList.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‡Ø¯Ø©.</p>";
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ù…Ù† Firestore
export async function loadCustody() {
  if (!custodyList) return;
  custodyList.innerHTML = "";

  try {
    const colRef = collection(db, "custody");
    const q = query(colRef, orderBy("createdAt", "desc"));
    const snap = await getDocs(q);

    const records = [];
    snap.forEach((d) => {
      records.push({ id: d.id, ...d.data() });
    });

    renderCustodyGrouped(records);
    document.dispatchEvent(new CustomEvent("custody-loaded", { detail: records }));
  } catch (err) {
    console.error(err);
    custodyList.innerHTML = "<p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‡Ø¯Ø©.</p>";
  }
}

document.addEventListener("user-ready", () => {
  loadCustody();
});
