// fleet.js
import {
  db,
  collection,
  doc,
  addDoc,
  getDocs,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  serverTimestamp
} from "./firebase.js";

import { currentUserProfile } from "./auth.js";
import { canManageFleet } from "./roles.js";

const fleetList = document.getElementById("fleetList");
const fleetFormContainer = document.getElementById("fleetFormContainer");
const addFleetBtn = document.getElementById("addFleetBtn");

function daysUntil(dateIso) {
  if (!dateIso) return null;
  const target = new Date(dateIso);
  const now = new Date();
  const diffMs = target.getTime() - now.getTime();
  return Math.ceil(diffMs / (1000 * 60 * 60 * 24));
}

function renderFleetForm(existing) {
  fleetFormContainer.innerHTML = "";
  const isEdit = !!existing;
  const card = document.createElement("div");
  card.className = "card";

  const title = document.createElement("h3");
  title.textContent = isEdit ? "ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠØ§Ø±Ø©" : "Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø£Ø³Ø·ÙˆÙ„";
  card.appendChild(title);

  const form = document.createElement("form");
  form.className = "form";

  form.innerHTML = `
    <div class="form-group">
      <label>Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
      <input type="text" name="carNumber" required value="${existing?.carNumber || ""}" />
    </div>
    <div class="form-group">
      <label>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©</label>
      <input type="text" name="plateCode" required value="${existing?.plateCode || ""}" />
    </div>
    <div class="form-group">
      <label>Ø§Ù„Ù…Ø§Ù„Ùƒ</label>
      <input type="text" name="owner" required value="${existing?.owner || ""}" />
    </div>
    <div class="form-group">
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
      <input type="text" name="carType" required value="${existing?.carType || ""}" />
    </div>
    <div class="form-group">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¹Ù‡Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input type="text" name="custodianName" value="${existing?.custodianName || ""}" />
    </div>
    <div class="form-group">
      <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
      <input type="date" name="licenseEndDate" value="${existing?.licenseEndDate || ""}" />
    </div>
    <div class="form-group">
      <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ£Ù…ÙŠÙ†</label>
      <input type="date" name="insuranceEndDate" value="${existing?.insuranceEndDate || ""}" />
    </div>
    <div class="form-group">
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea name="notes">${existing?.notes || ""}</textarea>
    </div>
    <p class="hint-text">
      ÙŠØªÙ… ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ø®ÙŠØµ Ø£Ùˆ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø¨Ù€ 15 ÙŠÙˆÙ…Ù‹Ø§.
    </p>
    <div class="form-inline" style="margin-top:0.5rem;">
      <button type="submit" class="btn btn-primary">${isEdit ? "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" : "Ø­ÙØ¸"}</button>
      <button type="button" class="btn btn-secondary" id="cancelFleetForm">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    const payload = {
      carNumber: data.carNumber.trim(),
      plateCode: data.plateCode.trim(),
      owner: data.owner.trim(),
      carType: data.carType.trim(),
      custodianName: data.custodianName.trim() || null,
      custodianUid: existing?.custodianUid || null,
      licenseEndDate: data.licenseEndDate || null,
      insuranceEndDate: data.insuranceEndDate || null,
      notes: data.notes.trim()
    };

    try {
      if (isEdit) {
        await updateDoc(doc(db, "fleet", existing.id), payload);
      } else {
        await addDoc(collection(db, "fleet"), {
          ...payload,
          createdAt: serverTimestamp()
        });
      }
      fleetFormContainer.classList.add("hidden");
      await loadFleet();
    } catch (err) {
      console.error(err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©.");
    }
  });

  card.appendChild(form);
  fleetFormContainer.appendChild(card);
  fleetFormContainer.classList.remove("hidden");

  document
    .getElementById("cancelFleetForm")
    .addEventListener("click", () => {
      fleetFormContainer.classList.add("hidden");
    });
}

if (addFleetBtn) {
  addFleetBtn.addEventListener("click", () => {
    const user = currentUserProfile;
    if (!canManageFleet(user.role)) {
      alert("Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø£Ø³Ø·ÙˆÙ„.");
      return;
    }
    renderFleetForm(null);
  });
}

function renderFleetItem(docId, data) {
  const user = currentUserProfile;
  if (!canManageFleet(user.role)) {
    return null; // Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ø§ ÙŠØ±Ù‰ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„
  }

  const item = document.createElement("div");
  item.className = "accordion-item";

  const header = document.createElement("div");
  header.className = "accordion-header";

  const headerMain = document.createElement("div");
  headerMain.className = "accordion-header-main";

  const title = document.createElement("div");
  title.className = "accordion-title";
  title.textContent = `${data.carNumber} - ${data.carType}`;

  const subtitle = document.createElement("div");
  subtitle.className = "accordion-subtitle";
  subtitle.textContent = `ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©: ${data.plateCode} | Ø§Ù„Ù…Ø§Ù„Ùƒ: ${data.owner}`;

  headerMain.appendChild(title);
  headerMain.appendChild(subtitle);

  const toggle = document.createElement("div");
  toggle.className = "accordion-toggle";
  toggle.textContent = "â–¼";

  header.appendChild(headerMain);
  header.appendChild(toggle);

  const body = document.createElement("div");
  body.className = "accordion-body hidden";

  const licenseDays = daysUntil(data.licenseEndDate);
  const insuranceDays = daysUntil(data.insuranceEndDate);

  const warningParts = [];
  if (licenseDays !== null && licenseDays <= 15 && licenseDays >= 0) {
    warningParts.push(`Ø§Ù„ØªØ±Ø®ÙŠØµ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${licenseDays} ÙŠÙˆÙ…`);
  }
  if (insuranceDays !== null && insuranceDays <= 15 && insuranceDays >= 0) {
    warningParts.push(`Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${insuranceDays} ÙŠÙˆÙ…`);
  }

  body.innerHTML = `
    <div class="accordion-body-row">
      <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
      <span class="value">${data.carNumber}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©:</span>
      <span class="value">${data.plateCode}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
      <span class="value">${data.owner}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
      <span class="value">${data.carType}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">Ù…Ù† Ø§Ù„Ù…ØªØ¹Ù‡Ø¯:</span>
      <span class="value">${data.custodianName || "-"}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ±Ø®ÙŠØµ:</span>
      <span class="value">${data.licenseEndDate || "-"}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ£Ù…ÙŠÙ†:</span>
      <span class="value">${data.insuranceEndDate || "-"}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
      <span class="value">${data.notes || "-"}</span>
    </div>
    ${
      warningParts.length
        ? `<div class="badge-warning" style="display:inline-block;margin-top:0.4rem;">
             ${warningParts.join(" - ")}
           </div>`
        : ""
    }
  `;

  const actions = document.createElement("div");
  actions.className = "accordion-actions";

  const shareBtn = document.createElement("button");
  shareBtn.className = "btn btn-secondary";
  shareBtn.textContent = "ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©";
  shareBtn.addEventListener("click", () => {
    const text = `
Ø¨ÙŠØ§Ù† Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ø·ÙˆÙ„
Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${data.carNumber}
ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©: ${data.plateCode}
Ø§Ù„Ù…Ø§Ù„Ùƒ: ${data.owner}
Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${data.carType}
Ø§Ù„Ù…ØªØ¹Ù‡Ø¯: ${data.custodianName || "-"}
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ±Ø®ÙŠØµ: ${data.licenseEndDate || "-"}
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ£Ù…ÙŠÙ†: ${data.insuranceEndDate || "-"}
Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${data.notes || "-"}
    `.trim();
    if (navigator.share) {
      navigator.share({ text }).catch(() => {});
    } else {
      navigator.clipboard?.writeText(text);
      alert("ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©.");
    }
  });

  const printBtn = document.createElement("button");
  printBtn.className = "btn btn-secondary";
  printBtn.textContent = "ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©";
  printBtn.addEventListener("click", () => {
    const w = window.open("", "_blank");
    w.document.write(`
      <html dir="rtl" lang="ar"><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ§Ø±Ø©</title></head><body>
      <h2>Ø¨ÙŠØ§Ù† Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h2>
      <p>Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${data.carNumber}</p>
      <p>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©: ${data.plateCode}</p>
      <p>Ø§Ù„Ù…Ø§Ù„Ùƒ: ${data.owner}</p>
      <p>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${data.carType}</p>
      <p>Ø§Ù„Ù…ØªØ¹Ù‡Ø¯: ${data.custodianName || "-"}</p>
      <p>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ±Ø®ÙŠØµ: ${data.licenseEndDate || "-"}</p>
      <p>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ£Ù…ÙŠÙ†: ${data.insuranceEndDate || "-"}</p>
      <p>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${data.notes || "-"}</p>
      </body></html>
    `);
    w.document.close();
    w.print();
  });

  actions.appendChild(shareBtn);
  actions.appendChild(printBtn);

  if (canManageFleet(user.role)) {
    const editBtn = document.createElement("button");
    editBtn.className = "btn btn-primary";
    editBtn.textContent = "âœ ØªØ¹Ø¯ÙŠÙ„";
    editBtn.addEventListener("click", () => {
      renderFleetForm({ id: docId, ...data });
    });
    actions.appendChild(editBtn);

    const deleteBtn = document.createElement("button");
    deleteBtn.className = "btn btn-danger";
    deleteBtn.textContent = "ğŸ—‘ Ø­Ø°Ù";
    deleteBtn.addEventListener("click", async () => {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ØŸ")) return;
      try {
        await deleteDoc(doc(db, "fleet", docId));
        await loadFleet();
      } catch (err) {
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù.");
      }
    });
    actions.appendChild(deleteBtn);
  }

  body.appendChild(actions);

  header.addEventListener("click", () => {
    const isHidden = body.classList.contains("hidden");
    body.classList.toggle("hidden", !isHidden);
    toggle.textContent = isHidden ? "â–²" : "â–¼";
  });

  item.appendChild(header);
  item.appendChild(body);

  return item;
}

export async function loadFleet() {
  if (!fleetList) return;
  fleetList.innerHTML = "";

  try {
    const colRef = collection(db, "fleet");
    const q = query(colRef, orderBy("createdAt", "desc"));
    const snap = await getDocs(q);

    snap.forEach((docSnap) => {
      const data = docSnap.data();
      const item = renderFleetItem(docSnap.id, data);
      if (item) fleetList.appendChild(item);
    });

    if (!fleetList.children.length) {
      fleetList.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø·ÙˆÙ„.</p>";
    }

    document.dispatchEvent(new CustomEvent("fleet-loaded"));
  } catch (err) {
    console.error(err);
    fleetList.innerHTML = "<p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø·ÙˆÙ„.</p>";
  }
}

document.addEventListener("user-ready", () => {
  const user = currentUserProfile;
  if (!canManageFleet(user.role)) {
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø¹Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
    const fleetTabBtn = document.querySelector('[data-main-tab="fleet"]');
    const fleetTab = document.getElementById("fleetTab");
    if (fleetTabBtn) fleetTabBtn.style.display = "none";
    if (fleetTab) fleetTab.style.display = "none";
    return;
  }
  loadFleet();
});
