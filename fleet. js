import { db, ref, push, onValue, update, remove } from "./firebase.js";

export function loadFleet(role, uid) {
  if (!['Ù…Ø·ÙˆØ±','Ù…Ø¯ÙŠØ±','Ù…Ø´Ø±Ù'].includes(role)) return;

  const content = document.getElementById('content');
  content.innerHTML = `
    <h2>Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h2>
    <button class="action-btn" id="add-fleet">+ Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</button>
    <div id="fleet-list"></div>
  `;

  const fleetRef = ref(db, 'fleet');
  onValue(fleetRef, (snapshot) => {
    const list = document.getElementById('fleet-list');
    list.innerHTML = '';
    const data = snapshot.val() || {};

    Object.keys(data).reverse().forEach(key => {
      const f = data[key];
      const licenseDays = daysLeft(f.licenseEnd);
      const insuranceDays = daysLeft(f.insuranceEnd);

      const accordion = document.createElement('div');
      accordion.className = 'accordion';
      accordion.innerHTML = `
        <strong>${f.carNumber} | ${f.carType}</strong>
        ${licenseDays <= 15 ? '<span style="color:red;"> âš  ØªÙ†Ø¨ÙŠÙ‡ ØªØ±Ø®ÙŠØµ</span>' : ''}
        ${insuranceDays <= 15 ? '<span style="color:red;"> âš  ØªÙ†Ø¨ÙŠÙ‡ ØªØ£Ù…ÙŠÙ†</span>' : ''}
      `;

      const panel = document.createElement('div');
      panel.className = 'panel';
      panel.innerHTML = `
        <p><strong>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©:</strong> ${f.plateCode}</p>
        <p><strong>Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> ${f.owner}</p>
        <p><strong>Ø§Ù„Ù…ØªØ¹Ù‡Ø¯:</strong> ${f.assignedTo || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
        <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${f.notes || '-'}</p>
        <p><strong>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ±Ø®ÙŠØµ:</strong> ${f.licenseEnd} (${licenseDays} ÙŠÙˆÙ…)</p>
        <p><strong>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ£Ù…ÙŠÙ†:</strong> ${f.insuranceEnd} (${insuranceDays} ÙŠÙˆÙ…)</p>
        <button class="action-btn" onclick="editFleet('${key}')">âœ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="action-btn" style="background:red;" onclick="deleteFleet('${key}')">ğŸ—‘ Ø­Ø°Ù</button>
      `;

      accordion.onclick = () => panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
      list.appendChild(accordion);
      list.appendChild(panel);
    });
  });

  document.getElementById('add-fleet').onclick = () => openFleetForm();
}

function daysLeft(dateStr) {
  if (!dateStr) return Infinity;
  const days = (new Date(dateStr) - new Date()) / (1000 * 60 * 60 * 24);
  return Math.ceil(days);
}

function openFleetForm(editKey = null) {
  const membersRef = ref(db, 'members');
  onValue(membersRef, (snap) => {
    let options = '<option value="">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>';
    snap.forEach(child => {
      options += `<option value="${child.val().username}">${child.val().username}</option>`;
    });

    const content = document.getElementById('content');
    content.innerHTML = `
      <h2>${editKey ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©'} Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø£Ø³Ø·ÙˆÙ„</h2>
      <label>Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</label><input type="text" id="carNumber">
      <label>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø©:</label><input type="text" id="plateCode">
      <label>Ø§Ù„Ù…Ø§Ù„Ùƒ:</label><input type="text" id="owner">
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</label><input type="text" id="carType">
      <label>Ø§Ù„Ù…ØªØ¹Ù‡Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label><select id="assignedTo">${options}</select>
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label><textarea id="notes"></textarea>
      <label>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ±Ø®ÙŠØµ:</label><input type="date" id="licenseEnd">
      <label>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ£Ù…ÙŠÙ†:</label><input type="date" id="insuranceEnd">
      <button class="action-btn" id="save-fleet">Ø­ÙØ¸</button>
      <button class="action-btn" onclick="loadFleet()">Ø¥Ù„ØºØ§Ø¡</button>
    `;

    if (editKey) {
      onValue(ref(db, 'fleet/' + editKey), (snap) => {
        const f = snap.val();
        document.getElementById('carNumber').value = f.carNumber;
        document.getElementById('plateCode').value = f.plateCode;
        document.getElementById('owner').value = f.owner;
        document.getElementById('carType').value = f.carType;
        document.getElementById('assignedTo').value = f.assignedTo || '';
        document.getElementById('notes').value = f.notes || '';
        document.getElementById('licenseEnd').value = f.licenseEnd;
        document.getElementById('insuranceEnd').value = f.insuranceEnd;
      }, { onlyOnce: true });
    }

    document.getElementById('save-fleet').onclick = () => {
      const fleetData = {
        carNumber: document.getElementById('carNumber').value,
        plateCode: document.getElementById('plateCode').value,
        owner: document.getElementById('owner').value,
        carType: document.getElementById('carType').value,
        assignedTo: document.getElementById('assignedTo').value,
        notes: document.getElementById('notes').value,
        licenseEnd: document.getElementById('licenseEnd').value,
        insuranceEnd: document.getElementById('insuranceEnd').value
      };

      if (editKey) {
        update(ref(db, 'fleet/' + editKey), fleetData);
      } else {
        push(ref(db, 'fleet'), fleetData);
      }
      loadFleet();
    };
  }, { onlyOnce: true });
}

window.editFleet = (key) => openFleetForm(key);
window.deleteFleet = (key) => { if (confirm('Ø­Ø°ÙØŸ')) remove(ref(db, 'fleet/' + key)); };