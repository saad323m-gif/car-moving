// members.js
import {
  db,
  collection,
  doc,
  getDocs,
  updateDoc,
  deleteDoc,
  query,
  orderBy
} from "./firebase.js";

import { currentUserProfile } from "./auth.js";
import {
  ROLE_DEVELOPER,
  ROLE_ADMIN,
  ROLE_SUPERVISOR,
  ROLE_MEMBER,
  ROLE_LABELS,
  ROLE_CLASS,
  canManageUsers
} from "./roles.js";

const membersList = document.getElementById("membersList");
const memberFormContainer = document.getElementById("memberFormContainer");
const addMemberBtn = document.getElementById("addMemberBtn");

// Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ù† Ù‚Ø¨Ù„ (Ù…Ø·ÙˆØ± + Ù…Ø¯ÙŠØ±) ÙÙ‚Ø·
function canEditMember(user) {
  return user && canManageUsers(user.role);
}

if (addMemberBtn) {
  addMemberBtn.addEventListener("click", () => {
    const user = currentUserProfile;
    if (!canEditMember(user)) {
      alert("ÙŠÙ…ÙƒÙ† ÙÙ‚Ø· Ù„Ù„Ù…Ø·ÙˆØ± Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯.");
      return;
    }
    renderMemberForm(null);
  });
}

function renderMemberForm(existing) {
  memberFormContainer.innerHTML = "";
  const isEdit = !!existing;
  const card = document.createElement("div");
  card.className = "card";

  const title = document.createElement("h3");
  title.textContent = isEdit ? "ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¶Ùˆ" : "Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ (ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·)";
  card.appendChild(title);

  const form = document.createElement("form");
  form.className = "form";

  form.innerHTML = `
    <div class="form-group">
      <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ</label>
      <input type="text" name="fullName" required value="${existing?.fullName || ""}" />
    </div>
    <div class="form-group">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input type="text" name="username" required minlength="4" value="${existing?.username || ""}" />
    </div>
    <div class="form-group">
      <label>ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (10 Ø£Ø±Ù‚Ø§Ù…)</label>
      <input type="tel" name="phone" required pattern="[0-9]{10}" value="${existing?.phone || ""}" />
    </div>
    <div class="form-group">
      <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
      <select name="role" required>
        <option value="${ROLE_DEVELOPER}" ${existing?.role === ROLE_DEVELOPER ? "selected" : ""}>${ROLE_LABELS[ROLE_DEVELOPER]}</option>
        <option value="${ROLE_ADMIN}" ${existing?.role === ROLE_ADMIN ? "selected" : ""}>${ROLE_LABELS[ROLE_ADMIN]}</option>
        <option value="${ROLE_SUPERVISOR}" ${existing?.role === ROLE_SUPERVISOR ? "selected" : ""}>${ROLE_LABELS[ROLE_SUPERVISOR]}</option>
        <option value="${ROLE_MEMBER}" ${existing?.role === ROLE_MEMBER ? "selected" : ""}>${ROLE_LABELS[ROLE_MEMBER]}</option>
      </select>
    </div>
    <p class="hint-text">
      Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ù† Ù‡Ù†Ø§ ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù‡Ø°Ø§ ÙŠØªÙ… Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„/Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ ÙÙŠØ±Ø¨ÙŠØ² Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹).
    </p>
    <div class="form-inline" style="margin-top:0.5rem;">
      <button type="submit" class="btn btn-primary">${isEdit ? "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" : "Ø­ÙØ¸"}</button>
      <button type="button" class="btn btn-secondary" id="cancelMemberForm">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());

    const payload = {
      fullName: data.fullName.trim(),
      username: data.username.trim(),
      phone: data.phone.trim(),
      role: data.role
    };

    try {
      if (isEdit) {
        await updateDoc(doc(db, "members", existing.uid), payload);
      }
      memberFormContainer.classList.add("hidden");
      await loadMembers();
    } catch (err) {
      console.error(err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ.");
    }
  });

  card.appendChild(form);
  memberFormContainer.appendChild(card);
  memberFormContainer.classList.remove("hidden");

  document
    .getElementById("cancelMemberForm")
    .addEventListener("click", () => {
      memberFormContainer.classList.add("hidden");
    });
}

function renderMemberItem(data) {
  const user = currentUserProfile;
  const isSelf = user && user.uid === data.uid;

  const item = document.createElement("div");
  item.className = "accordion-item";

  const header = document.createElement("div");
  header.className = "accordion-header";

  const headerMain = document.createElement("div");
  headerMain.className = "accordion-header-main";

  const title = document.createElement("div");
  title.className = "accordion-title";
  title.textContent = data.fullName;

  const badge = document.createElement("span");
  badge.className = `role-badge ${ROLE_CLASS[data.role] || ""}`;
  badge.textContent = ROLE_LABELS[data.role] || "";
  title.appendChild(document.createTextNode(" "));
  title.appendChild(badge);

  const subtitle = document.createElement("div");
  subtitle.className = "accordion-subtitle";
  subtitle.textContent = `Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.username}`;

  headerMain.appendChild(title);
  headerMain.appendChild(subtitle);

  const toggle = document.createElement("div");
  toggle.className = "accordion-toggle";
  toggle.textContent = "â–¼";

  header.appendChild(headerMain);
  header.appendChild(toggle);

  const body = document.createElement("div");
  body.className = "accordion-body hidden";

  body.innerHTML = `
    <div class="accordion-body-row">
      <span class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</span>
      <span class="value">${data.fullName}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
      <span class="value">${data.username}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">Ø§Ù„Ù‡Ø§ØªÙ:</span>
      <span class="value">${data.phone}</span>
    </div>
    <div class="accordion-body-row">
      <span class="label">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</span>
      <span class="value">${ROLE_LABELS[data.role] || ""}</span>
    </div>
  `;

  const actions = document.createElement("div");
  actions.className = "accordion-actions";

  const shareBtn = document.createElement("button");
  shareBtn.className = "btn btn-secondary";
  shareBtn.textContent = "ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©";
  shareBtn.addEventListener("click", () => {
    const text = `
Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ
Ø§Ù„Ø§Ø³Ù…: ${data.fullName}
Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.username}
Ø§Ù„Ù‡Ø§ØªÙ: ${data.phone}
Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ${ROLE_LABELS[data.role] || ""}
    `.trim();
    if (navigator.share) {
      navigator.share({ text }).catch(() => {});
    } else {
      navigator.clipboard?.writeText(text);
      alert("ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ.");
    }
  });
  actions.appendChild(shareBtn);

  if (canEditMember(user)) {
    const editBtn = document.createElement("button");
    editBtn.className = "btn btn-primary";
    editBtn.textContent = "âœ ØªØ¹Ø¯ÙŠÙ„";
    editBtn.addEventListener("click", () => {
      renderMemberForm(data);
    });
    actions.appendChild(editBtn);

    if (!isSelf) {
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn btn-danger";
      deleteBtn.textContent = "ğŸ—‘ Ø­Ø°Ù";
      deleteBtn.addEventListener("click", async () => {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ (Ù„Ù† ÙŠØ­Ø°Ù Ø­Ø³Ø§Ø¨ Firebase)") )
          return;
        try {
          await deleteDoc(doc(db, "members", data.uid));
          await loadMembers();
        } catch (err) {
          console.error(err);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ.");
        }
      });
      actions.appendChild(deleteBtn);
    }
  }

  body.appendChild(actions);

  header.addEventListener("click", () => {
    const isHidden = body.classList.contains("hidden");
    body.classList.toggle("hidden", !isHidden);
    toggle.textContent = isHidden ? "â–²" : "â–¼";
  });

  item.appendChild(header);
  item.appendChild(body);

  return item;
}

export async function loadMembers() {
  if (!membersList) return;
  membersList.innerHTML = "";

  try {
    const colRef = collection(db, "members");
    const q = query(colRef, orderBy("fullName", "asc"));
    const snap = await getDocs(q);

    const user = currentUserProfile;
    const canSeeAll = true; // ÙŠÙ…ÙƒÙ† Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø±Ø¤ÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ØŒ Ù…Ø¹ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„

    const records = [];
    snap.forEach((docSnap) => {
      const data = docSnap.data();
      data.uid = docSnap.id;
      records.push(data);
    });

    records.forEach((m) => {
      if (!canSeeAll && m.uid !== user.uid) return;
      const item = renderMemberItem(m);
      membersList.appendChild(item);
    });

    if (!membersList.children.length) {
      membersList.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙˆÙ†.</p>";
    }

    document.dispatchEvent(new CustomEvent("members-loaded", { detail: records }));
  } catch (err) {
    console.error(err);
    membersList.innerHTML = "<p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.</p>";
  }
}

document.addEventListener("user-ready", () => {
  loadMembers();
});
