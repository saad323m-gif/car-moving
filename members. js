import { db, ref, push, onValue, update, remove } from "./firebase.js";

export function loadMembers(role, uid) {
  if (role !== 'Ù…Ø·ÙˆØ±' && role !== 'Ù…Ø¯ÙŠØ±') return;

  const content = document.getElementById('content');
  content.innerHTML = `
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
    <button class="action-btn" id="add-member">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</button>
    <div id="members-list"></div>
  `;

  const membersRef = ref(db, 'members');
  onValue(membersRef, (snapshot) => {
    const list = document.getElementById('members-list');
    list.innerHTML = '';
    snapshot.forEach(child => {
      const m = child.val();
      const roleColor = m.role === 'Ù…Ø·ÙˆØ±' ? 'red' : m.role === 'Ù…Ø¯ÙŠØ±' ? 'orange' : m.role === 'Ù…Ø´Ø±Ù' ? 'darkblue' : 'green';

      const div = document.createElement('div');
      div.className = 'accordion';
      div.innerHTML = `<strong style="color:${roleColor};">${m.username} - ${m.role}</strong>`;

      const panel = document.createElement('div');
      panel.className = 'panel';
      panel.innerHTML = `
        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> ${m.phone || '-'}</p>
        <button class="action-btn" onclick="editMember('${child.key}')">âœ ØªØ¹Ø¯ÙŠÙ„</button>
        ${m.role !== 'Ù…Ø·ÙˆØ±' ? `<button class="action-btn" style="background:red;" onclick="deleteMember('${child.key}')">ğŸ—‘ Ø­Ø°Ù</button>` : ''}
      `;

      div.onclick = () => panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
      list.appendChild(div);
      list.appendChild(panel);
    });
  });

  document.getElementById('add-member').onclick = () => openMemberForm();
}

function openMemberForm(editKey = null) {
  const content = document.getElementById('content');
  content.innerHTML = `
    <h2>${editKey ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©'} Ø¹Ø¶Ùˆ</h2>
    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label><input type="text" id="username" minlength="4">
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¥Ø°Ø§ Ø¬Ø¯ÙŠØ¯):</label><input type="password" id="password" ${editKey ? '' : 'required'} minlength="6">
    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (10 Ø£Ø±Ù‚Ø§Ù…):</label><input type="tel" id="phone" pattern="[0-9]{10}">
    <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</label>
    <select id="role">
      <option value="Ø¹Ø¶Ùˆ">Ø¹Ø¶Ùˆ</option>
      <option value="Ù…Ø´Ø±Ù">Ù…Ø´Ø±Ù</option>
      <option value="Ù…Ø¯ÙŠØ±">Ù…Ø¯ÙŠØ±</option>
      ${editKey ? '' : '<option value="Ù…Ø·ÙˆØ±">Ù…Ø·ÙˆØ±</option>'}
    </select>
    <button class="action-btn" id="save-member">Ø­ÙØ¸</button>
    <button class="action-btn" onclick="loadMembers()">Ø¥Ù„ØºØ§Ø¡</button>
  `;

  if (editKey) {
    onValue(ref(db, 'members/' + editKey), (snap) => {
      const m = snap.val();
      document.getElementById('username').value = m.username;
      document.getElementById('phone').value = m.phone || '';
      document.getElementById('role').value = m.role;
    }, { onlyOnce: true });
  }

  document.getElementById('save-member').onclick = async () => {
    // Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ auth.js Ù„Ø§Ø­Ù‚Ø§Ù‹ (Ù‡Ù†Ø§ ÙÙ‚Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ)
    const memberData = {
      username: document.getElementById('username').value,
      phone: document.getElementById('phone').value,
      role: document.getElementById('role').value
    };
    if (editKey) {
      update(ref(db, 'members/' + editKey), memberData);
    } else {
      // Ù„Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªØ§Ø¬ ØªØ³Ø¬ÙŠÙ„ auth Ø£ÙˆÙ„Ø§Ù‹ (ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø·ÙˆØ± ÙÙ‚Ø·)
      alert('Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„ Ù…Ø±Ø© Ø«Ù… Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
    }
    loadMembers();
  };
}

window.editMember = (key) => openMemberForm(key);
window.deleteMember = (key) => { if (confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ø¶ÙˆØŸ')) remove(ref(db, 'members/' + key)); };